[
    {
        "id": "9e669e5ed5a2dd65",
        "type": "tab",
        "label": "Logic",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "799b2714689c52e7",
        "type": "group",
        "z": "9e669e5ed5a2dd65",
        "name": "Global",
        "style": {
            "stroke": "#92d04f",
            "label": true
        },
        "nodes": [
            "77180feaff4d5130",
            "8d63d1f942513785",
            "e40e28f78177c084",
            "152abbb1a32b6e9a",
            "a71380698545bfba",
            "cccf876a7687d60e",
            "71ccf33bbbf63800",
            "20587a1a488be3fa",
            "7d074ce8d581dc21",
            "cfca5f7ee9f39ce2",
            "60d9ccd74b3d5f01",
            "0861f8ee76b43a91"
        ],
        "x": 34,
        "y": 59,
        "w": 692,
        "h": 202
    },
    {
        "id": "17965c4b9f2a83c3",
        "type": "group",
        "z": "9e669e5ed5a2dd65",
        "name": "FromAdmin",
        "style": {
            "stroke": "#0070c0",
            "label": true
        },
        "nodes": [
            "876ca2a327bbf742",
            "4fbea48f5fcac951",
            "1597a5bfc8b290dd",
            "cab0a4cf864ec59a",
            "682fd7e93e8fc114",
            "d3eed86c91985361",
            "09a0b63bfe2f9446",
            "e1e8004ec44efff9",
            "6b282a5cf59047e7",
            "10eac66d955f5767",
            "1105a126875d3f23",
            "7b7a917b5834de34",
            "2ae4172c5dd7168e",
            "50d817cb7369edd3",
            "305cfab9683c882d",
            "1659225c58a2b8ab",
            "f40ecfa286fb73f8",
            "ff109eead4511781",
            "df2a1ab13eaea41e",
            "753af792a60ccefd",
            "a4e2566ba24aa781",
            "275457d43ea42730",
            "4f37e869cdf617e0",
            "39029260de6af61e",
            "c9ef96841114bd54",
            "1935934b4e85e6d0",
            "e8932bcdc24b40b4",
            "e849e62835a29646"
        ],
        "x": 34,
        "y": 279,
        "w": 1012,
        "h": 362
    },
    {
        "id": "6abd0468fa0eb05f",
        "type": "group",
        "z": "9e669e5ed5a2dd65",
        "name": "Telegram",
        "style": {
            "label": true,
            "stroke": "#6f2fa0"
        },
        "nodes": [
            "207452c206175db4",
            "d6d765afce457014",
            "ab90216c2ae6e11d",
            "63754cfcec88b374",
            "ad170c2e86c27030",
            "11b2638e9536d230",
            "f95e06ae225e6a94",
            "8f9c85e145e4bf38",
            "90d7c105a2800509"
        ],
        "x": 34,
        "y": 659,
        "w": 1312,
        "h": 142
    },
    {
        "id": "8a7cfdf064b038c2",
        "type": "group",
        "z": "9e669e5ed5a2dd65",
        "name": "Demo",
        "style": {
            "stroke": "#ffC000",
            "label": true
        },
        "nodes": [
            "71c998ce734f0f5a",
            "c09c22fe123e75df",
            "da1f9c67b7e5ebad",
            "69dde419548f29fd",
            "9b6f914c73aa4ccd",
            "3cba732b968ed1c9",
            "76f1ed83e535349c"
        ],
        "x": 34,
        "y": 819,
        "w": 1092,
        "h": 142
    },
    {
        "id": "358625d2fca13e88",
        "type": "group",
        "z": "9e669e5ed5a2dd65",
        "name": "History of conversation",
        "style": {
            "label": true,
            "stroke": "#ff0000"
        },
        "nodes": [
            "4da3d1084865862f",
            "d6395fb4748d1ebc",
            "eaff589e72bcdafc",
            "3003b7b6b8c27e44",
            "2aecefea8e7b8ef1",
            "6e2ed4604324edd6",
            "e6590abc5860c593"
        ],
        "x": 34,
        "y": 979,
        "w": 672,
        "h": 142
    },
    {
        "id": "664f1e7115a34974",
        "type": "telegram bot",
        "botname": "{global.get('process_env').BOT_NAME}",
        "usernames": "",
        "chatids": "",
        "baseapiurl": "",
        "updatemode": "polling",
        "pollinterval": "300",
        "usesocks": false,
        "sockshost": "",
        "socksprotocol": "socks5",
        "socksport": "6667",
        "socksusername": "anonymous",
        "sockspassword": "",
        "bothost": "",
        "botpath": "",
        "localbotport": "8443",
        "publicbotport": "8443",
        "privatekey": "",
        "certificate": "",
        "useselfsignedcertificate": false,
        "sslterminated": false,
        "verboselogging": false
    },
    {
        "id": "77180feaff4d5130",
        "type": "inject",
        "z": "9e669e5ed5a2dd65",
        "g": "799b2714689c52e7",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 150,
        "y": 140,
        "wires": [
            [
                "152abbb1a32b6e9a"
            ]
        ]
    },
    {
        "id": "8d63d1f942513785",
        "type": "function",
        "z": "9e669e5ed5a2dd65",
        "g": "799b2714689c52e7",
        "name": "ENV",
        "func": "const data = msg.payload\n\nlet process_env = {\n    BOT_NAME: data.bot_name,\n    BOT_TOKEN: data.bot_token,\n    OPENAI_API: data.openai_api,\n    IS_LIMIT: data.is_limit,\n    LIMIT: +data.limit\n}\n\nglobal.set(\"process_env\", process_env)\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 650,
        "y": 120,
        "wires": [
            []
        ]
    },
    {
        "id": "e40e28f78177c084",
        "type": "complete",
        "z": "9e669e5ed5a2dd65",
        "g": "799b2714689c52e7",
        "name": "",
        "scope": [
            "4fbea48f5fcac951"
        ],
        "uncaught": false,
        "x": 130,
        "y": 100,
        "wires": [
            [
                "152abbb1a32b6e9a"
            ]
        ]
    },
    {
        "id": "152abbb1a32b6e9a",
        "type": "function",
        "z": "9e669e5ed5a2dd65",
        "g": "799b2714689c52e7",
        "name": "getEnvs",
        "func": "msg.filename = '/data/credentials.json'\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 320,
        "y": 120,
        "wires": [
            [
                "a71380698545bfba"
            ]
        ]
    },
    {
        "id": "876ca2a327bbf742",
        "type": "http in",
        "z": "9e669e5ed5a2dd65",
        "g": "17965c4b9f2a83c3",
        "name": "",
        "url": "/saveCredentials",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 160,
        "y": 320,
        "wires": [
            [
                "1597a5bfc8b290dd"
            ]
        ]
    },
    {
        "id": "4fbea48f5fcac951",
        "type": "http response",
        "z": "9e669e5ed5a2dd65",
        "g": "17965c4b9f2a83c3",
        "name": "saveCredentials",
        "statusCode": "",
        "headers": {},
        "x": 940,
        "y": 320,
        "wires": []
    },
    {
        "id": "1597a5bfc8b290dd",
        "type": "function",
        "z": "9e669e5ed5a2dd65",
        "g": "17965c4b9f2a83c3",
        "name": "set filename",
        "func": "msg.filename = '/data/credentials.json'\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 370,
        "y": 320,
        "wires": [
            [
                "10eac66d955f5767"
            ]
        ]
    },
    {
        "id": "cab0a4cf864ec59a",
        "type": "file",
        "z": "9e669e5ed5a2dd65",
        "g": "17965c4b9f2a83c3",
        "name": "",
        "filename": "filename",
        "filenameType": "msg",
        "appendNewline": true,
        "createDir": true,
        "overwriteFile": "true",
        "encoding": "none",
        "x": 640,
        "y": 320,
        "wires": [
            [
                "682fd7e93e8fc114"
            ]
        ]
    },
    {
        "id": "682fd7e93e8fc114",
        "type": "function",
        "z": "9e669e5ed5a2dd65",
        "g": "17965c4b9f2a83c3",
        "name": "return res",
        "func": "msg.payload={\n    success: true,\n    payload: \"Success!\"\n}\nmsg.statusCode = 200\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 780,
        "y": 320,
        "wires": [
            [
                "4fbea48f5fcac951"
            ]
        ]
    },
    {
        "id": "d3eed86c91985361",
        "type": "http in",
        "z": "9e669e5ed5a2dd65",
        "g": "17965c4b9f2a83c3",
        "name": "",
        "url": "/saveContent",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 150,
        "y": 400,
        "wires": [
            [
                "f40ecfa286fb73f8"
            ]
        ]
    },
    {
        "id": "09a0b63bfe2f9446",
        "type": "http response",
        "z": "9e669e5ed5a2dd65",
        "g": "17965c4b9f2a83c3",
        "name": "saveContent",
        "statusCode": "",
        "headers": {},
        "x": 950,
        "y": 400,
        "wires": []
    },
    {
        "id": "e1e8004ec44efff9",
        "type": "file",
        "z": "9e669e5ed5a2dd65",
        "g": "17965c4b9f2a83c3",
        "name": "",
        "filename": "filename",
        "filenameType": "msg",
        "appendNewline": true,
        "createDir": true,
        "overwriteFile": "true",
        "encoding": "none",
        "x": 640,
        "y": 400,
        "wires": [
            [
                "6b282a5cf59047e7"
            ]
        ]
    },
    {
        "id": "6b282a5cf59047e7",
        "type": "function",
        "z": "9e669e5ed5a2dd65",
        "g": "17965c4b9f2a83c3",
        "name": "return res",
        "func": "msg.payload={\n    success: true,\n    payload: \"Success!\"\n}\nmsg.statusCode = 200\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 800,
        "y": 400,
        "wires": [
            [
                "09a0b63bfe2f9446"
            ]
        ]
    },
    {
        "id": "10eac66d955f5767",
        "type": "json",
        "z": "9e669e5ed5a2dd65",
        "g": "17965c4b9f2a83c3",
        "name": "",
        "property": "payload",
        "action": "",
        "pretty": false,
        "x": 510,
        "y": 320,
        "wires": [
            [
                "cab0a4cf864ec59a"
            ]
        ]
    },
    {
        "id": "1105a126875d3f23",
        "type": "file in",
        "z": "9e669e5ed5a2dd65",
        "g": "17965c4b9f2a83c3",
        "name": "",
        "filename": "filename",
        "filenameType": "msg",
        "format": "utf8",
        "chunk": false,
        "sendError": false,
        "encoding": "none",
        "allProps": false,
        "x": 520,
        "y": 480,
        "wires": [
            [
                "7b7a917b5834de34"
            ]
        ]
    },
    {
        "id": "7b7a917b5834de34",
        "type": "json",
        "z": "9e669e5ed5a2dd65",
        "g": "17965c4b9f2a83c3",
        "name": "",
        "property": "payload",
        "action": "",
        "pretty": false,
        "x": 650,
        "y": 480,
        "wires": [
            [
                "305cfab9683c882d"
            ]
        ]
    },
    {
        "id": "2ae4172c5dd7168e",
        "type": "http in",
        "z": "9e669e5ed5a2dd65",
        "g": "17965c4b9f2a83c3",
        "name": "",
        "url": "/getCredentials",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 150,
        "y": 480,
        "wires": [
            [
                "1659225c58a2b8ab"
            ]
        ]
    },
    {
        "id": "50d817cb7369edd3",
        "type": "http response",
        "z": "9e669e5ed5a2dd65",
        "g": "17965c4b9f2a83c3",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 930,
        "y": 480,
        "wires": []
    },
    {
        "id": "305cfab9683c882d",
        "type": "function",
        "z": "9e669e5ed5a2dd65",
        "g": "17965c4b9f2a83c3",
        "name": "return res",
        "func": "msg.statusCode = 200\nglobal.set('isCredentialsSent', true)\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 800,
        "y": 480,
        "wires": [
            [
                "50d817cb7369edd3"
            ]
        ]
    },
    {
        "id": "1659225c58a2b8ab",
        "type": "function",
        "z": "9e669e5ed5a2dd65",
        "g": "17965c4b9f2a83c3",
        "name": "set filename",
        "func": "msg.filename = '/data/credentials.json'\nglobal.set('isCredentialsSent', false)\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 350,
        "y": 480,
        "wires": [
            [
                "1105a126875d3f23",
                "e849e62835a29646"
            ]
        ]
    },
    {
        "id": "f40ecfa286fb73f8",
        "type": "function",
        "z": "9e669e5ed5a2dd65",
        "g": "17965c4b9f2a83c3",
        "name": "set filename",
        "func": "msg.filename = '/data/content.json'\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 350,
        "y": 400,
        "wires": [
            [
                "ff109eead4511781"
            ]
        ]
    },
    {
        "id": "ff109eead4511781",
        "type": "json",
        "z": "9e669e5ed5a2dd65",
        "g": "17965c4b9f2a83c3",
        "name": "",
        "property": "payload",
        "action": "",
        "pretty": false,
        "x": 510,
        "y": 400,
        "wires": [
            [
                "e1e8004ec44efff9"
            ]
        ]
    },
    {
        "id": "df2a1ab13eaea41e",
        "type": "file in",
        "z": "9e669e5ed5a2dd65",
        "g": "17965c4b9f2a83c3",
        "name": "",
        "filename": "filename",
        "filenameType": "msg",
        "format": "utf8",
        "chunk": false,
        "sendError": false,
        "encoding": "none",
        "allProps": false,
        "x": 520,
        "y": 560,
        "wires": [
            [
                "753af792a60ccefd"
            ]
        ]
    },
    {
        "id": "753af792a60ccefd",
        "type": "json",
        "z": "9e669e5ed5a2dd65",
        "g": "17965c4b9f2a83c3",
        "name": "",
        "property": "payload",
        "action": "",
        "pretty": false,
        "x": 650,
        "y": 560,
        "wires": [
            [
                "4f37e869cdf617e0"
            ]
        ]
    },
    {
        "id": "a4e2566ba24aa781",
        "type": "http in",
        "z": "9e669e5ed5a2dd65",
        "g": "17965c4b9f2a83c3",
        "name": "",
        "url": "/getContent",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 140,
        "y": 560,
        "wires": [
            [
                "39029260de6af61e"
            ]
        ]
    },
    {
        "id": "275457d43ea42730",
        "type": "http response",
        "z": "9e669e5ed5a2dd65",
        "g": "17965c4b9f2a83c3",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 930,
        "y": 560,
        "wires": []
    },
    {
        "id": "4f37e869cdf617e0",
        "type": "function",
        "z": "9e669e5ed5a2dd65",
        "g": "17965c4b9f2a83c3",
        "name": "return res",
        "func": "msg.statusCode = 200\nglobal.set('isContentSent', true)\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 800,
        "y": 560,
        "wires": [
            [
                "275457d43ea42730"
            ]
        ]
    },
    {
        "id": "39029260de6af61e",
        "type": "function",
        "z": "9e669e5ed5a2dd65",
        "g": "17965c4b9f2a83c3",
        "name": "set filename",
        "func": "msg.filename = '/data/content.json'\nglobal.set('isContentSent', false)\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 350,
        "y": 560,
        "wires": [
            [
                "df2a1ab13eaea41e",
                "1935934b4e85e6d0"
            ]
        ]
    },
    {
        "id": "a71380698545bfba",
        "type": "file in",
        "z": "9e669e5ed5a2dd65",
        "g": "799b2714689c52e7",
        "name": "",
        "filename": "filename",
        "filenameType": "msg",
        "format": "utf8",
        "chunk": false,
        "sendError": false,
        "encoding": "none",
        "allProps": false,
        "x": 480,
        "y": 120,
        "wires": [
            [
                "cccf876a7687d60e"
            ]
        ]
    },
    {
        "id": "cccf876a7687d60e",
        "type": "json",
        "z": "9e669e5ed5a2dd65",
        "g": "799b2714689c52e7",
        "name": "",
        "property": "payload",
        "action": "",
        "pretty": false,
        "x": 565,
        "y": 120,
        "wires": [
            [
                "8d63d1f942513785"
            ]
        ],
        "l": false
    },
    {
        "id": "20587a1a488be3fa",
        "type": "inject",
        "z": "9e669e5ed5a2dd65",
        "g": "799b2714689c52e7",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 150,
        "y": 220,
        "wires": [
            [
                "7d074ce8d581dc21"
            ]
        ]
    },
    {
        "id": "0861f8ee76b43a91",
        "type": "function",
        "z": "9e669e5ed5a2dd65",
        "g": "799b2714689c52e7",
        "name": "ENV",
        "func": "const data = msg.payload\nconst filterHtmlTags = (text) => {\n    // Remove all HTML tags except for <br> and <br/>\n    const filteredText = text.replace(/<(?!br\\s*\\/?)[^>]+>/gi, '');\n    // Replace <br> and <br/> tags with newline characters\n    return filteredText.replace(/<br\\s*\\/?>/gi, '\\n');\n}\n\n\ndata.welcomeMessage = filterHtmlTags(data.welcomeMessage)\nlet content = {\n    WELCOME_MSG: data.welcomeMessage,\n    INSTRUCTIONS: data.insturctions\n}\n\nglobal.set(\"content\", content)\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 650,
        "y": 200,
        "wires": [
            []
        ]
    },
    {
        "id": "71ccf33bbbf63800",
        "type": "complete",
        "z": "9e669e5ed5a2dd65",
        "g": "799b2714689c52e7",
        "name": "",
        "scope": [
            "09a0b63bfe2f9446"
        ],
        "uncaught": false,
        "x": 130,
        "y": 180,
        "wires": [
            [
                "7d074ce8d581dc21"
            ]
        ]
    },
    {
        "id": "7d074ce8d581dc21",
        "type": "function",
        "z": "9e669e5ed5a2dd65",
        "g": "799b2714689c52e7",
        "name": "getContent",
        "func": "msg.filename = '/data/content.json'\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 330,
        "y": 200,
        "wires": [
            [
                "cfca5f7ee9f39ce2"
            ]
        ]
    },
    {
        "id": "cfca5f7ee9f39ce2",
        "type": "file in",
        "z": "9e669e5ed5a2dd65",
        "g": "799b2714689c52e7",
        "name": "",
        "filename": "filename",
        "filenameType": "msg",
        "format": "utf8",
        "chunk": false,
        "sendError": false,
        "encoding": "none",
        "allProps": false,
        "x": 480,
        "y": 200,
        "wires": [
            [
                "60d9ccd74b3d5f01"
            ]
        ]
    },
    {
        "id": "60d9ccd74b3d5f01",
        "type": "json",
        "z": "9e669e5ed5a2dd65",
        "g": "799b2714689c52e7",
        "name": "",
        "property": "payload",
        "action": "",
        "pretty": false,
        "x": 565,
        "y": 200,
        "wires": [
            [
                "0861f8ee76b43a91"
            ]
        ],
        "l": false
    },
    {
        "id": "d6d765afce457014",
        "type": "function",
        "z": "9e669e5ed5a2dd65",
        "g": "6abd0468fa0eb05f",
        "name": "check command",
        "func": "msg.fromTG = msg.payload\nif (msg.payload.content === '/start'){\n    return [msg, null]\n}else{\n    return [null, msg]\n}",
        "outputs": 2,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 360,
        "y": 720,
        "wires": [
            [
                "63754cfcec88b374"
            ],
            [
                "90d7c105a2800509"
            ]
        ]
    },
    {
        "id": "63754cfcec88b374",
        "type": "function",
        "z": "9e669e5ed5a2dd65",
        "g": "6abd0468fa0eb05f",
        "name": "/start",
        "func": "msg.payload.content = global.get('content').WELCOME_MSG\n\nglobal.set(`history${msg.fromTG.chatId}`, [{ role: 'system', content: `${global.get('content').INSTRUCTIONS}` }, { role: 'assistant', content: `${global.get('content').WELCOME_MSG}`}])\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 510,
        "y": 700,
        "wires": [
            [
                "ab90216c2ae6e11d"
            ]
        ]
    },
    {
        "id": "ad170c2e86c27030",
        "type": "function",
        "z": "9e669e5ed5a2dd65",
        "g": "6abd0468fa0eb05f",
        "name": "to ChatGPT",
        "func": "//set variables\nconst api_key = global.get('process_env').OPENAI_API;\nconst content = msg.fromTG.content;\nlet history = global.get(`history${msg.fromTG.chatId}`) || [];\n\n//ChatGPT properties\nmsg.url = 'https://api.openai.com/v1/chat/completions';\nmsg.headers = {\n    'Content-Type': 'application/json',\n    'Authorization': `Bearer ${api_key}`\n};\n\nmsg.payload = {\n    \"model\": \"gpt-4\",\n    \"messages\": [\n        { \"role\": \"system\", \"content\": global.get('content').INSTRUCTIONS},\n        { \"role\": \"user\", \"content\": content}\n    ]\n}\n\n// update global variables\nhistory.push({ \"role\": \"user\", \"content\": content });\nglobal.set(`history${msg.fromTG.chatId}`, history);\nglobal.set('sent', false)\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 690,
        "y": 760,
        "wires": [
            [
                "11b2638e9536d230"
            ]
        ]
    },
    {
        "id": "11b2638e9536d230",
        "type": "http request",
        "z": "9e669e5ed5a2dd65",
        "g": "6abd0468fa0eb05f",
        "name": "ChatGPT",
        "method": "POST",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 840,
        "y": 760,
        "wires": [
            [
                "8f9c85e145e4bf38"
            ]
        ]
    },
    {
        "id": "8f9c85e145e4bf38",
        "type": "function",
        "z": "9e669e5ed5a2dd65",
        "g": "6abd0468fa0eb05f",
        "name": "send to user from chat",
        "func": "const responseChatGPT = msg.payload.choices[0].message.content\nlet history = global.get(`history${msg.fromTG.chatId}`) || [];\n\nmsg.payload = {\n    ...msg.fromTG,\n    content: responseChatGPT,\n    type: \"message\",\n}\n\nif (global.get('sent') == false) {\n    global.set('sent', true)\n\n    history.push({ \"role\": \"assistant\", \"content\": responseChatGPT });\n    global.set(`history${msg.fromTG.chatId}`, history);\n    return msg;\n}",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1020,
        "y": 760,
        "wires": [
            [
                "f95e06ae225e6a94"
            ]
        ]
    },
    {
        "id": "c9ef96841114bd54",
        "type": "function",
        "z": "9e669e5ed5a2dd65",
        "g": "17965c4b9f2a83c3",
        "name": "default data",
        "func": "if (global.get('isContentSent') === false) {\nmsg.payload={\n    welcomeMessage: \n`Hello! Welcome to our store.\nWe're excited to help you find the perfect product for your needs.\nHow we can help you?`,\n    insturctions: \n`You are an assistant in an E-commerce store that sells fashion accessories.\n\nCustomers could ask you questions about product information, order status, shipping, and returns.\n\nHere's an example:\n\nQuestion: \"What's the material of the green scarf with flowers on your website?\"\nAnswer: \"The green scarf with flowers on our website is made of 100% silk.\"\n\nQuestion: \"Where's my order?\"\nAnswer: \"To check the status of your order, please log in to your account on our website and go to the 'Orders' section. You should see the status of your order there.\"\n\nQuestion: \"How long does it take to receive my order?\"\nAnswer: \"The delivery time depends on your location and the shipping method you choose at checkout. Please refer to our Shipping and Delivery page on our website for more information.\"\n\nQuestion: \"What's your return policy?\"\nAnswer: \"We offer free returns within 30 days of purchase. Please log in to your account and go to the 'Returns' section to initiate a return.\n`\n}\n\nglobal.set('isContentSent', true)\nreturn msg;\n}",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 610,
        "y": 600,
        "wires": [
            [
                "4f37e869cdf617e0"
            ]
        ]
    },
    {
        "id": "1935934b4e85e6d0",
        "type": "delay",
        "z": "9e669e5ed5a2dd65",
        "g": "17965c4b9f2a83c3",
        "name": "",
        "pauseType": "delay",
        "timeout": "3",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 495,
        "y": 600,
        "wires": [
            [
                "c9ef96841114bd54"
            ]
        ],
        "l": false
    },
    {
        "id": "e8932bcdc24b40b4",
        "type": "function",
        "z": "9e669e5ed5a2dd65",
        "g": "17965c4b9f2a83c3",
        "name": "default data",
        "func": "if (global.get('isCredentialsSent') === false){\n    msg.payload = {\n        \"bot_name\": '',\n        \"bot_token\": '',\n        \"openai_api\": '',\n        \"is_limit\": true,\n        \"limit\": 30\n    }\n    global.set('isCredentialsSent', true)\n    return msg;\n}\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 610,
        "y": 520,
        "wires": [
            [
                "305cfab9683c882d"
            ]
        ]
    },
    {
        "id": "e849e62835a29646",
        "type": "delay",
        "z": "9e669e5ed5a2dd65",
        "g": "17965c4b9f2a83c3",
        "name": "",
        "pauseType": "delay",
        "timeout": "3",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 495,
        "y": 520,
        "wires": [
            [
                "e8932bcdc24b40b4"
            ]
        ],
        "l": false
    },
    {
        "id": "71c998ce734f0f5a",
        "type": "function",
        "z": "9e669e5ed5a2dd65",
        "g": "8a7cfdf064b038c2",
        "name": "to ChatGPT",
        "func": "//set variables\nconst api_key = global.get('process_env').OPENAI_API;\n\nconst content = msg.payload.content;\nlet historyForGPT = global.get(`historyDemo`) || [];\n\n//ChatGPT properties\nmsg.url = 'https://api.openai.com/v1/chat/completions';\nmsg.headers = {\n    'Content-Type': 'application/json',\n    'Authorization': `Bearer ${api_key}`\n};\n\nmsg.payload = {\n    \"model\": \"gpt-3.5-turbo\",\n    \"messages\": [\n        ...historyForGPT,\n        { \"role\": \"user\", \"content\": content}\n    ]\n}\n\nglobal.set(`historyDemo`, msg.payload.messages);\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 510,
        "y": 920,
        "wires": [
            [
                "c09c22fe123e75df"
            ]
        ]
    },
    {
        "id": "c09c22fe123e75df",
        "type": "http request",
        "z": "9e669e5ed5a2dd65",
        "g": "8a7cfdf064b038c2",
        "name": "ChatGPT",
        "method": "POST",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 680,
        "y": 920,
        "wires": [
            [
                "da1f9c67b7e5ebad"
            ]
        ]
    },
    {
        "id": "da1f9c67b7e5ebad",
        "type": "function",
        "z": "9e669e5ed5a2dd65",
        "g": "8a7cfdf064b038c2",
        "name": "send to user from chat",
        "func": "const responseChatGPT = msg.payload.choices[0].message.content;\nconst history = global.get(`historyDemo`) || [];\nhistory.push({ \"role\": \"assistant\", \"content\": responseChatGPT })\nglobal.set(`historyDemo`, history);\n\n\nhistory[0] = {\n    role: 'user',\n    content: '/start'\n}\n\nconst conversation = history.map(e => ({ content: e.content.replace(/\\n/g, '')}));\nmsg.payload = conversation\n\n\n/*\nmsg.payload = history.map(e => {\n    if (e.role == 'user') {\n        return `User: ${e.content}`\n    } else {\n        return `AI: ${e.content}`\n    }\n}).join('\\n\\n')*/\n\n\n//const history = history.concat({\"text\": responseChatGPT });\n\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 860,
        "y": 920,
        "wires": [
            [
                "9b6f914c73aa4ccd"
            ]
        ]
    },
    {
        "id": "69dde419548f29fd",
        "type": "http in",
        "z": "9e669e5ed5a2dd65",
        "g": "8a7cfdf064b038c2",
        "name": "",
        "url": "/demo",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 130,
        "y": 880,
        "wires": [
            [
                "3cba732b968ed1c9"
            ]
        ]
    },
    {
        "id": "9b6f914c73aa4ccd",
        "type": "http response",
        "z": "9e669e5ed5a2dd65",
        "g": "8a7cfdf064b038c2",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 1050,
        "y": 860,
        "wires": []
    },
    {
        "id": "3cba732b968ed1c9",
        "type": "function",
        "z": "9e669e5ed5a2dd65",
        "g": "8a7cfdf064b038c2",
        "name": "check command",
        "func": "if (msg.payload.content.includes('/start')){\n    return [msg, null]\n}else{\n    return [null, msg]\n}",
        "outputs": 2,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 300,
        "y": 880,
        "wires": [
            [
                "76f1ed83e535349c"
            ],
            [
                "71c998ce734f0f5a"
            ]
        ]
    },
    {
        "id": "76f1ed83e535349c",
        "type": "function",
        "z": "9e669e5ed5a2dd65",
        "g": "8a7cfdf064b038c2",
        "name": "/start",
        "func": "msg.payload = [{ content: '/start' }, { content: global.get('content').WELCOME_MSG}]\n\nglobal.set(`historyDemo`, [{ role: 'system', content: `${global.get('content').INSTRUCTIONS}` }, { role: 'assistant', content: `${global.get('content').WELCOME_MSG}`}])\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 490,
        "y": 860,
        "wires": [
            [
                "9b6f914c73aa4ccd"
            ]
        ]
    },
    {
        "id": "207452c206175db4",
        "type": "telegram receiver",
        "z": "9e669e5ed5a2dd65",
        "g": "6abd0468fa0eb05f",
        "name": "",
        "bot": "664f1e7115a34974",
        "saveDataDir": "",
        "filterCommands": false,
        "x": 150,
        "y": 720,
        "wires": [
            [
                "d6d765afce457014"
            ],
            []
        ]
    },
    {
        "id": "ab90216c2ae6e11d",
        "type": "telegram sender",
        "z": "9e669e5ed5a2dd65",
        "g": "6abd0468fa0eb05f",
        "name": "",
        "bot": "664f1e7115a34974",
        "haserroroutput": false,
        "outputs": 1,
        "x": 710,
        "y": 700,
        "wires": [
            []
        ]
    },
    {
        "id": "f95e06ae225e6a94",
        "type": "telegram sender",
        "z": "9e669e5ed5a2dd65",
        "g": "6abd0468fa0eb05f",
        "name": "",
        "bot": "664f1e7115a34974",
        "haserroroutput": false,
        "outputs": 1,
        "x": 1230,
        "y": 760,
        "wires": [
            []
        ]
    },
    {
        "id": "90d7c105a2800509",
        "type": "function",
        "z": "9e669e5ed5a2dd65",
        "g": "6abd0468fa0eb05f",
        "name": "check count",
        "func": "let receivedMessages = global.get(\"receivedMessages\") || [];\nconst limit = global.get('process_env').LIMIT ?? 30\n\nnode.warn(limit);\nfunction checkMessages() {\n    const now = Date.now();\n    receivedMessages = receivedMessages.filter(t => now - t <= 3600000);\n    if(receivedMessages.length <= +limit){\n        receivedMessages.push(now);\n    }\n}\n\ncheckMessages();\nglobal.set('receivedMessages', receivedMessages);\n\nif (receivedMessages.length > +limit) {\n    msg.payload.content = 'Борис каже, що я задорогий, і маю працювати з розумом. Може ще напишіть завтра, а поки, поговоріть з нашими адмінами 🙃 @WaLviv';\n    return [msg, null];\n} else {\n    return [null, msg];\n}",
        "outputs": 2,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 530,
        "y": 760,
        "wires": [
            [
                "ab90216c2ae6e11d"
            ],
            [
                "ad170c2e86c27030"
            ]
        ]
    },
    {
        "id": "4da3d1084865862f",
        "type": "function",
        "z": "9e669e5ed5a2dd65",
        "g": "358625d2fca13e88",
        "name": "get",
        "func": "const historyKey = global.keys().filter(e=> e.includes('history'))\n\nconst history = historyKey.map(key=> {\n    const value = global.get(key)\n    return {\n        [key.replace('history', '')]: value\n    }\n})\n\nmsg.payload = {\n    success: true,\n    payload: {\n        historyLength: history.length\n    }\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 310,
        "y": 1020,
        "wires": [
            [
                "eaff589e72bcdafc"
            ]
        ]
    },
    {
        "id": "d6395fb4748d1ebc",
        "type": "http in",
        "z": "9e669e5ed5a2dd65",
        "g": "358625d2fca13e88",
        "name": "",
        "url": "/getHistory",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 140,
        "y": 1020,
        "wires": [
            [
                "4da3d1084865862f"
            ]
        ]
    },
    {
        "id": "eaff589e72bcdafc",
        "type": "http response",
        "z": "9e669e5ed5a2dd65",
        "g": "358625d2fca13e88",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 450,
        "y": 1020,
        "wires": []
    },
    {
        "id": "3003b7b6b8c27e44",
        "type": "inject",
        "z": "9e669e5ed5a2dd65",
        "g": "358625d2fca13e88",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "3600",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 150,
        "y": 1080,
        "wires": [
            [
                "2aecefea8e7b8ef1"
            ]
        ]
    },
    {
        "id": "2aecefea8e7b8ef1",
        "type": "function",
        "z": "9e669e5ed5a2dd65",
        "g": "358625d2fca13e88",
        "name": "save histrory",
        "func": "const historyKey = global.keys().filter(e=> e.includes('history'))\n\nconst history = historyKey.map(key=> {\n    const value = global.get(key)\n    return {\n        [key.replace('history', '')]: value\n    }\n})\n\nmsg.payload = history\nmsg.filename = '/data/history.json'\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 310,
        "y": 1080,
        "wires": [
            [
                "e6590abc5860c593"
            ]
        ]
    },
    {
        "id": "6e2ed4604324edd6",
        "type": "file",
        "z": "9e669e5ed5a2dd65",
        "g": "358625d2fca13e88",
        "name": "",
        "filename": "filename",
        "filenameType": "msg",
        "appendNewline": true,
        "createDir": true,
        "overwriteFile": "true",
        "encoding": "none",
        "x": 620,
        "y": 1080,
        "wires": [
            []
        ]
    },
    {
        "id": "e6590abc5860c593",
        "type": "json",
        "z": "9e669e5ed5a2dd65",
        "g": "358625d2fca13e88",
        "name": "",
        "property": "payload",
        "action": "",
        "pretty": false,
        "x": 470,
        "y": 1080,
        "wires": [
            [
                "6e2ed4604324edd6"
            ]
        ]
    }
]